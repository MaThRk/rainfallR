<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extract Rainfalldata for landslide-initiation points • rainfallR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extract Rainfalldata for landslide-initiation points">
<meta property="og:description" content="rainfallR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rainfallR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ExamplePolygonExtraction.html">ExamplePolygonExtraction</a>
    </li>
    <li>
      <a href="../articles/example_bozen.html">Extracting data for bozen</a>
    </li>
    <li>
      <a href="../articles/extract_rainfall_landslidePoints.html">Extract Rainfalldata for landslide-initiation points</a>
    </li>
    <li>
      <a href="../articles/extract_rainfall_slope_unit.html"> Extract rainfall data for slopeunit-polygons</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="extract_rainfall_landslidePoints_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extract Rainfalldata for landslide-initiation points</h1>
            
      
      
      <div class="hidden name"><code>extract_rainfall_landslidePoints.Rmd</code></div>

    </div>

    
    
<div id="set-some-paths" class="section level1">
<h1 class="hasAnchor">
<a href="#set-some-paths" class="anchor"></a>Set some paths</h1>
<ul>
<li>First we need to set some paths to the appropriate data locations</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># the path to the iffi polygons</span>
<span class="va">landslide_poly_path</span> <span class="op">=</span> <span class="st">"\\\\projectdata.eurac.edu/projects/Proslide/Landslides/Iffi_db_xxxx_to_2018/exportperEurac2020/Shapefiles/IFFI10_5.shp"</span>

<span class="co"># the path to the iffi points</span>
<span class="va">landslide_point_path</span> <span class="op">=</span> <span class="st">"\\\\projectdata.eurac.edu/projects/Proslide/Landslides/Iffi_db_xxxx_to_2018/exportperEurac2020/Shapefiles/IFFI10_1.shp"</span> 

<span class="co"># the path to the folder with the iffi-databases </span>
<span class="va">database_dir</span> <span class="op">=</span> <span class="st">"\\\\projectdata.eurac.edu/projects/Proslide/Landslides/Iffi_db_xxxx_to_2018/exportperEurac2020/database"</span> 

<span class="co"># the path to the root folder of the gridded rainfall data</span>
<span class="va">path_ncdf</span> <span class="op">=</span> <span class="st">"\\\\projectdata.eurac.edu/projects/Proslide/PREC_GRIDS_updated/"</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load some libraries</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rainfallR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/slowkow/ggrepel">ggrepel</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gganimate.com">gganimate</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RODBC</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">iffitoR</span><span class="op">)</span> <span class="co"># load some sample landslide data that comes with the package</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://forcats.tidyverse.org">forcats</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/crayon#readme">crayon</a></span><span class="op">)</span> <span class="co"># for some colours</span></code></pre></div>
</div>
<div id="get-iffi-data-iffitor" class="section level1">
<h1 class="hasAnchor">
<a href="#get-iffi-data-iffitor" class="anchor"></a>Get iffi data (iffitoR)</h1>
<ul>
<li>In order to get the date information for the points and the polygons we will use the <code>iffitoR</code>-pacakge which facilitates the access to the iffi database a little bit</li>
</ul>
<div id="call-the-make_shapefile-function" class="section level2">
<h2 class="hasAnchor">
<a href="#call-the-make_shapefile-function" class="anchor"></a>Call the make_shapefile function</h2>
<ul>
<li><p>First we will query some more data for the point information in the scarve of the landslides</p></li>
<li><p>We can do the procedure here manually or use the <code>landsld</code>-dataset that comes with the <code>iffitoR</code>-package</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># only query the data when working under windows due to the RODBC drivers</span>
<span class="va">os</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="st">"sysname"</span><span class="op">]</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">os</span> <span class="op">==</span> <span class="st">"Windows"</span><span class="op">)</span> <span class="op">{</span>
  
<span class="va">iffi_points</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iffitoR/man/make_shapefile.html">make_shapefile</a></span><span class="op">(</span>
  database_dir <span class="op">=</span> <span class="va">database_dir</span>,
  <span class="co"># normally null only setting it here for me</span>
  attribute_database_name <span class="op">=</span> <span class="st">"tbl_frane"</span>,
  <span class="co"># the name without extension</span>
  dictionary_database_name <span class="op">=</span> <span class="st">"diz_frane"</span>,
  shapefile <span class="op">=</span> <span class="va">landslide_point_path</span>, 
  
  <span class="co"># the colums we want to retrieve directly</span>
  attri <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"anno_min"</span>,
            <span class="st">"mese_min"</span>,
            <span class="st">"giorno_min"</span>,
            <span class="st">"area"</span><span class="op">)</span>,

  <span class="co"># tables to join from the other tables (for more see vignette)</span>
  joins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"tbl_frane.Generalita.Cod_tipo"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"diz_frane.diz_tipo_movi.cod_tipo"</span>,
      <span class="st">"diz_frane.diz_tipo_movi.tipologia"</span>
    <span class="op">)</span>,
    <span class="st">"tbl_frane.clas_ii_liv.movimento"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"diz_frane.diz_movimenti.movimento"</span>,
      <span class="st">"diz_frane.diz_movimenti.nome_movimento"</span>
    <span class="op">)</span>,
    <span class="st">"tbl_frane.ass_gen_cause.causa"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"diz_frane.diz_cause.causa"</span>,
      <span class="st">"diz_frane.diz_cause.nome_causa"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="op">}</span></code></pre></div>
<ul>
<li>lets have a little look at what we got back?</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># what have we got</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">iffi_points</span><span class="op">)</span></code></pre></div>
</div>
<div id="filter-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#filter-the-data" class="anchor"></a>Filter the data</h2>
<ul>
<li><p>the time information is in the columns <code>anno_min</code>, <code>mese_min</code> and <code>giorno_min</code></p></li>
<li><p>the first and second level are still in italian, wo do some more preprocessing</p></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="va">os</span> <span class="op">==</span> <span class="st">"Windows"</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># translate the two classifying columns to english</span>
  <span class="va">iffi_points_1</span> <span class="op">=</span> <span class="fu">iffitoR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/iffitoR/man/translate_iffi.html">translate_iffi</a></span><span class="op">(</span><span class="va">iffi_points</span><span class="op">)</span>
  
  <span class="co"># get some more date information</span>
  <span class="va">iffi_points_2</span> <span class="op">=</span> <span class="fu">iffitoR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/iffitoR/man/get_date_information.html">get_date_information</a></span><span class="op">(</span><span class="va">iffi_points_1</span><span class="op">)</span>
  
  <span class="co"># drop the geometry, so that it gets a little more space</span>
  <span class="va">iffi_points_2</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"date|day|year|month|first|second"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<ul>
<li>next we filter the data a little more in order to only get the translational sldides that have information about the da of occurence and happened after 1980</li>
</ul>
</div>
</div>
<div id="get-the-rainfall-data" class="section level1">
<h1 class="hasAnchor">
<a href="#get-the-rainfall-data" class="anchor"></a>Get the rainfall data</h1>
<div id="bring-the-data-in-the-right-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#bring-the-data-in-the-right-structure" class="anchor"></a>bring the data in the right structure</h2>
<ul>
<li><p>We not only want the rainfall at the day of occurrence, but also the 7 days before the actualy event happened</p></li>
<li><p>As we have one raster per day and one raster covers the entire province of South Tyrol, we will make a list of all the events that happened on the same day. This will prevent us of extracting the same raster twice.</p></li>
<li><p>The names of the list will be the dates. Each day will have a dataframe with one row per event that happened on that day</p></li>
<li><p>We can use the function <code>iffi10_same_day</code> for that</p></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># now lets use the data that comes already preprocessed with the iffitoR package</span>
<span class="co"># we need to filter the right slides as we did above for the data queried from the databse</span>
<span class="va">landsld</span> <span class="op">=</span> <span class="va">landsld</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">second_level</span>, <span class="st">"translational|rotational|fast"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date_info</span> <span class="op">==</span> <span class="st">"day"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year.int</span> <span class="op">&gt;=</span> <span class="fl">1980</span><span class="op">)</span> 

<span class="co"># get all the slides from the same day</span>
<span class="va">slides_same_day</span> <span class="op">=</span>  <span class="fu"><a href="../reference/iffi10_same_day.html">iffi10_same_day</a></span><span class="op">(</span><span class="va">landsld</span><span class="op">)</span></code></pre></div>
<ul>
<li>What is the max number of slides per day and on which day ?</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create a vector of the slides per day</span>
<span class="va">n_slides_per_day</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">slides_same_day</span>, <span class="va">nrow</span><span class="op">)</span>

<span class="co"># what is the max slides per day</span>
<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">n_slides_per_day</span><span class="op">)</span>

<span class="co"># when did it happen</span>
<span class="va">n_slides_per_day</span><span class="op">[</span><span class="va">n_slides_per_day</span> <span class="op">==</span> <span class="va">m</span><span class="op">]</span>
<span class="co">#&gt; 20181029 </span>
<span class="co">#&gt;       18</span></code></pre></div>
</div>
<div id="get-the-rainfall-data-1" class="section level2">
<h2 class="hasAnchor">
<a href="#get-the-rainfall-data-1" class="anchor"></a>get the rainfall data</h2>
<ul>
<li><p>for each day (each element in the list above) we now extract the rainfall data</p></li>
<li><p>therefore we use the <code>rainfallR</code>-package and its simple functions</p></li>
<li><p>We essentially extract the right raster from a bunch of NetCDf-files and extract then the raster-value (the rainfall) under the point of consideration</p></li>
<li><p>According to the implementation of <code>rainfallR</code> on the days with only one slide we get back a simple dataframe per day (yet in the wrong format that will be re-formatted with the <code>make_cumulative_rainfall</code>-function). When we extract data for more than one slide per day, we also get back a dataframe per say in a little different format and witch a unique identifier per slide</p></li>
<li><p>The <code>rainfallR</code>-function was intended to work with multiple days. However, it only supports the extracting of one spatial object (be it multiple points or polygons per day). Here however, we we want to extract the rainfall for various different days for different spatial objects. So we need to write a for loop</p></li>
<li><p>This is one (probably not the most effective one) to do in in sequence</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># lets only take a smaller subset</span>
<span class="va">slides_same_day</span> <span class="op">=</span> <span class="va">slides_same_day</span>

<span class="co"># for each day get the rainfall at the slide location</span>
<span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span>

<span class="co"># measure the time</span>
<span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># iterate over the spatial object</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># print some informative message</span>
  <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span>
  <span class="va">str</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">i</span>, <span class="st">"/"</span>, <span class="va">n</span><span class="op">)</span>
  <span class="va">dashes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">20</span>, <span class="st">"-"</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">yellow</span><span class="op">$</span><span class="va">bold</span><span class="op">$</span><span class="fu">underline</span><span class="op">(</span><span class="st">"\n------------"</span>, <span class="va">str</span>, <span class="va">dashes</span>, <span class="st">"\n\n"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># get the date of the slides</span>
  <span class="co"># this is one of the inputs to the function</span>
  <span class="va">date</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"%Y%m%d"</span><span class="op">)</span>

  <span class="co"># the spatial object</span>
  <span class="co"># another input</span>
  <span class="va">spatial.obj</span> <span class="op">=</span> <span class="va">slides_same_day</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>

  <span class="co"># how many days looking back?</span>
  <span class="va">days_back</span> <span class="op">=</span><span class="fl">7</span> 

  <span class="co"># this returns a list with one element</span>
  <span class="co"># if the dts-argument would have more than one data this list would have more arguments</span>
  <span class="va">rf</span> <span class="op">=</span> <span class="fu">rainfallR</span><span class="fu">::</span><span class="fu"><a href="../reference/ex_rainfall.html">ex_rainfall</a></span><span class="op">(</span>
    spatial.obj <span class="op">=</span> <span class="va">spatial.obj</span>,
    fun <span class="op">=</span> <span class="cn">NULL</span>,
    date <span class="op">=</span> <span class="va">date</span>,
    days_back <span class="op">=</span> <span class="va">days_back</span>
  <span class="op">)</span>
  
  <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">rf</span>
  
<span class="op">}</span>

<span class="va">res1</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>

<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">took1</span><span class="op">=</span><span class="va">end</span><span class="op">-</span><span class="va">start</span></code></pre></div>
</div>
</div>
<div id="can-we-do-this-in-parallel" class="section level1">
<h1 class="hasAnchor">
<a href="#can-we-do-this-in-parallel" class="anchor"></a>Can we do this in parallel?</h1>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: Paket 'foreach' wurde unter R Version 4.0.3 erstellt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attache Paket: 'foreach'</span>
<span class="co">#&gt; The following objects are masked from 'package:purrr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     accumulate, when</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="co">#&gt; Warning: Paket 'doParallel' wurde unter R Version 4.0.3 erstellt</span>
<span class="co">#&gt; Lade nötiges Paket: iterators</span>
<span class="co">#&gt; Warning: Paket 'iterators' wurde unter R Version 4.0.3 erstellt</span>
<span class="co">#&gt; Lade nötiges Paket: parallel</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>


<span class="co"># lets only take a smaller subset</span>
<span class="va">slides_same_day</span> <span class="op">=</span> <span class="va">slides_same_day</span><span class="op">[</span><span class="op">]</span>

<span class="co"># # for each day get the rainfall at the slide location</span>
<span class="co"># out = vector("list", length=length(slides_same_day))</span>
<span class="co"># names(out) = names(slides_same_day)</span>

<span class="co"># measure the time</span>
<span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>

<span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span>, 
        .combine<span class="op">=</span><span class="va">rbind</span>,
        .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rainfallR"</span>,
                      <span class="st">"magrittr"</span>,
                      <span class="st">"stringr"</span>,
                      <span class="st">"dplyr"</span><span class="op">)</span><span class="op">)</span> <span class="op">%dopar%</span><span class="op">{</span>
  
  <span class="co"># get the date of the slides</span>
  <span class="co"># this is one of the inputs to the function</span>
  <span class="va">date</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"%Y%m%d"</span><span class="op">)</span>

  <span class="co"># the spatial object</span>
  <span class="va">spatial.obj</span> <span class="op">=</span> <span class="va">slides_same_day</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>

  <span class="co"># some other arguments</span>
  <span class="va">days_back</span> <span class="op">=</span><span class="fl">7</span> 

  <span class="co"># this returns a list with one element</span>
  <span class="co"># if the dts-argument would have more than one data this list would have more arguments</span>
  <span class="va">rf</span> <span class="op">=</span> <span class="fu">rainfallR</span><span class="fu">::</span><span class="fu"><a href="../reference/ex_rainfall.html">ex_rainfall</a></span><span class="op">(</span>
    spatial.obj <span class="op">=</span> <span class="va">spatial.obj</span>,
    fun <span class="op">=</span> <span class="cn">NULL</span>,
    <span class="co"># as we are using points</span>
    date <span class="op">=</span> <span class="va">date</span>,
    days_back <span class="op">=</span> <span class="va">days_back</span>
  <span class="op">)</span>
                      <span class="op">}</span>

<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">took2</span><span class="op">=</span><span class="va">end</span><span class="op">-</span><span class="va">start</span></code></pre></div>
<ul>
<li>The extraction in parallel took 5.77944795290629 minutes.</li>
</ul>
</div>
<div id="inspect-what-we-got" class="section level1">
<h1 class="hasAnchor">
<a href="#inspect-what-we-got" class="anchor"></a>Inspect what we got</h1>
<div id="cumulative-antecedent-rainfall" class="section level2">
<h2 class="hasAnchor">
<a href="#cumulative-antecedent-rainfall" class="anchor"></a>Cumulative antecedent rainfall</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gg</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span>
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">days_before_event</span>, <span class="va">cumsum</span>, group<span class="op">=</span><span class="va">PIFF_ID</span>, col<span class="op">=</span><span class="va">second_level</span><span class="op">)</span>,
    alpha<span class="op">=</span><span class="fl">.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"Movement type"</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"purple"</span>, <span class="st">"green"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    y <span class="op">=</span> <span class="st">"Cumulative rainfann [mm]"</span>,
    x <span class="op">=</span> <span class="st">"Days before event"</span>,
    title <span class="op">=</span> <span class="st">"Amount of antecedent rainfall [mm]"</span>
  <span class="op">)</span>

<span class="va">day_for_dir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"-"</span>, <span class="st">""</span><span class="op">)</span>

<span class="va">file</span> <span class="op">=</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"plots/"</span>, <span class="va">day_for_dir</span>, <span class="st">"/antecent_rainfall_different_second_level.png"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># ggsave(filename = file, plot = gg) </span></code></pre></div>
</div>
<div id="single-rainfall-days-before-event" class="section level2">
<h2 class="hasAnchor">
<a href="#single-rainfall-days-before-event" class="anchor"></a>Single rainfall days before event</h2>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mean_daily_precip"</span> <span class="op">=</span> <span class="st">"Mean Daily Precipiation"</span> , <span class="st">"mean_cumulative_precip"</span> <span class="op">=</span> <span class="st">"Mean Cumulative Precipitation"</span><span class="op">)</span>

<span class="va">res</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">second_level</span>, <span class="va">days_before_event</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>mean_daily_precip <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">precip</span><span class="op">)</span>,
            mean_cumulative_precip <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cumsum</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"mean"</span><span class="op">)</span>,
               values_to <span class="op">=</span> <span class="st">"value"</span>,
               names_to <span class="op">=</span> <span class="st">"dimension"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">days_before_event</span>, y <span class="op">=</span> <span class="va">value</span>, col <span class="op">=</span> <span class="va">second_level</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Type of Movement"</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fast flow-type"</span> <span class="op">=</span> <span class="st">"purple"</span>, <span class="st">"translational slide"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"rotational slide"</span> <span class="op">=</span>  <span class="st">"green"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">dimension</span>, labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html">as_labeller</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Days before Event"</span>,
    y <span class="op">=</span> <span class="st">"Precipitation [mm]"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"black"</span><span class="op">)</span>,
    strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"white"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'second_level' (override with `.groups` argument)</span>
<span class="co">#&gt; Warning in val_cols[col_id] &lt;- unname(as.list(data[cols])): Anzahl der zu</span>
<span class="co">#&gt; ersetzenden Elemente ist kein Vielfaches der Ersetzungslänge</span></code></pre></div>
<p><img src="extract_rainfall_landslidePoints_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R">  
<span class="va">file</span> <span class="op">=</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"plots/"</span>, <span class="va">day_for_dir</span>, <span class="st">"/mean_rainfall_per_type.png"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># ggsave(file)</span></code></pre></div>
</div>
</div>
<div id="difference-in-amount-of-rainfall-between-start-and-end" class="section level1">
<h1 class="hasAnchor">
<a href="#difference-in-amount-of-rainfall-between-start-and-end" class="anchor"></a>Difference in amount of rainfall between start and end</h1>
<ul>
<li>In the above graphic it’s hard to see the evolution of one path</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">PIFF_ID</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    diff <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">last</a></span><span class="op">(</span><span class="va">cumsum</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">cumsum</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    sd <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span>,
    outlier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">&gt;</span> <span class="va">sd</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span> 
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span>
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">days_before_event</span>, y <span class="op">=</span> <span class="va">cumsum</span>, group<span class="op">=</span><span class="va">PIFF_ID</span>, col <span class="op">=</span> <span class="va">diff</span>,
                  alpha <span class="op">=</span> <span class="va">diff</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html">scale_colour_continuous</a></span><span class="op">(</span>
    name<span class="op">=</span><span class="st">"Absolute Difference in precipitation between last and first day"</span>, 
    low <span class="op">=</span> <span class="st">"white"</span>, 
    high<span class="op">=</span><span class="st">"red"</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Days before Event"</span>,
    y <span class="op">=</span> <span class="st">"cumulative precipitation [mm]"</span>,
    title <span class="op">=</span> <span class="st">"Precipitation [mm] before a graviational mass movement"</span>,
    subtitle <span class="op">=</span> <span class="st">"(translational and rotational movements)"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>
  <span class="op">)</span></code></pre></div>
<p><img src="extract_rainfall_landslidePoints_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># ggsave("../../../presentations/internship_resume/plots/plots/precipitation_all_trans_and_rotational_movements.png", width = 12, height = 8)</span></code></pre></div>
<div id="landslides-with-little-antecedent-rainfall" class="section level2">
<h2 class="hasAnchor">
<a href="#landslides-with-little-antecedent-rainfall" class="anchor"></a>Landslides with little antecedent rainfall</h2>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">PIFF_ID</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    diff <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">last</a></span><span class="op">(</span><span class="va">cumsum</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">cumsum</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    sd <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span>,
    outlier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">&gt;</span> <span class="va">sd</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span> 
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span>
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">days_before_event</span>, y <span class="op">=</span> <span class="va">cumsum</span>, group<span class="op">=</span><span class="va">PIFF_ID</span>, col <span class="op">=</span> <span class="va">diff</span>,
                  alpha <span class="op">=</span> <span class="va">diff</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html">scale_colour_continuous</a></span><span class="op">(</span>
    name<span class="op">=</span><span class="st">"Absolute Difference in precipitation between last and first day"</span>, 
    low <span class="op">=</span> <span class="st">"red"</span>, 
    high<span class="op">=</span><span class="st">"white"</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Days before Event"</span>,
    y <span class="op">=</span> <span class="st">"cumulative precipitation [mm]"</span>,
    title <span class="op">=</span> <span class="st">"Precipitation [mm] before an graviational mass movement"</span>,
    subtitle <span class="op">=</span> <span class="st">"(translational and rotational movements)"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>
  <span class="op">)</span> </code></pre></div>
<p><img src="extract_rainfall_landslidePoints_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># ggsave("../../../presentations/internship_resume/plots/plots/precipitation_all_trans_and_rotational_movements_reverse.png", width = 12, height = 8)</span></code></pre></div>
</div>
</div>
<div id="do-it-for-all-types-of-movements" class="section level1">
<h1 class="hasAnchor">
<a href="#do-it-for-all-types-of-movements" class="anchor"></a>Do it for all types of movements</h1>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># now lets use the data that comes already preprocessed with the iffitoR package</span>
<span class="co"># we need to filter the right slides as we did above for the data queried from the databse</span>

<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"landsld"</span><span class="op">)</span><span class="op">)</span>
<span class="va">landsld</span> <span class="op">=</span> <span class="va">landsld</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date_info</span> <span class="op">==</span> <span class="st">"day"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year.int</span> <span class="op">&gt;=</span> <span class="fl">1980</span><span class="op">)</span> 

<span class="va">slides_same_day</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">row</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">landsld</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># get the day of the event</span>
  <span class="va">dts</span> <span class="op">=</span> <span class="va">landsld</span><span class="op">[</span><span class="va">row</span>,<span class="op">]</span><span class="op">[[</span><span class="st">"date"</span><span class="op">]</span><span class="op">]</span>
  <span class="va">dts_chr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span><span class="op">(</span><span class="va">dts</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"-"</span>, <span class="st">""</span><span class="op">)</span>

  <span class="co"># add this spatial object to the list with the name being the day</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">dts_chr</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">slides_same_day</span><span class="op">[[</span><span class="va">dts_chr</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">[[</span><span class="va">dts_chr</span><span class="op">]</span><span class="op">]</span>, <span class="va">landsld</span><span class="op">[</span><span class="va">row</span>,<span class="op">]</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span>
    <span class="va">slides_same_day</span><span class="op">[[</span><span class="va">dts_chr</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">landsld</span><span class="op">[</span><span class="va">row</span>, <span class="op">]</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co"># which was the day with the most movements overall</span>
<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">slides_same_day</span>, <span class="va">nrow</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/which.minmax.html">which.max</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>


<span class="co"># for each day get the rainfall at the slide location</span>

<span class="co"># measure the time</span>
<span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>
<span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span>, 
        .combine<span class="op">=</span><span class="va">rbind</span>,
        .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rainfallR"</span>,
                      <span class="st">"magrittr"</span>,
                      <span class="st">"stringr"</span>,
                      <span class="st">"dplyr"</span><span class="op">)</span><span class="op">)</span> <span class="op">%dopar%</span><span class="op">{</span>
  
  <span class="co"># get the date of the slides</span>
  <span class="co"># this is one of the inputs to the function</span>
  <span class="va">date</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">slides_same_day</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"%Y%m%d"</span><span class="op">)</span>

  <span class="co"># the spatial object</span>
  <span class="co"># another input</span>
  <span class="va">spatial.obj</span> <span class="op">=</span> <span class="va">slides_same_day</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>

  <span class="co"># some other arguments</span>
  <span class="va">days_back</span> <span class="op">=</span><span class="fl">7</span> 

  <span class="co"># this returns a list with one element</span>
  <span class="co"># if the dts-argument would have more than one data this list would have more arguments</span>
  <span class="va">rf</span> <span class="op">=</span> <span class="fu">rainfallR</span><span class="fu">::</span><span class="fu"><a href="../reference/ex_rainfall.html">ex_rainfall</a></span><span class="op">(</span>
    spatial.obj <span class="op">=</span> <span class="va">spatial.obj</span>,
    fun <span class="op">=</span> <span class="cn">NULL</span>,
    date <span class="op">=</span> <span class="va">date</span>,
    days_back <span class="op">=</span> <span class="va">days_back</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">took3</span><span class="op">=</span><span class="va">end</span><span class="op">-</span><span class="va">start</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>res <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="st">  </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(cumsum)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="st">  </span><span class="kw">group_by</span>(PIFF_ID) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="dt">diff =</span> <span class="kw">last</span>(cumsum) <span class="op">-</span><span class="st"> </span><span class="kw">first</span>(cumsum)</span>
<span id="cb18-7"><a href="#cb18-7"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="st">  </span><span class="kw">group_by</span>(second_level) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">n =</span> <span class="kw">n</span>(),</span>
<span id="cb18-11"><a href="#cb18-11"></a>    <span class="dt">second_level =</span> <span class="kw">glue</span>(<span class="st">"{second_level} ({n / 8} )"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_diff =</span> <span class="kw">mean</span>(diff)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb18-15"><a href="#cb18-15"></a>    <span class="dt">second_level =</span> <span class="kw">fct_reorder</span>(second_level, mean_diff)</span>
<span id="cb18-16"><a href="#cb18-16"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-17"><a href="#cb18-17"></a><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb18-18"><a href="#cb18-18"></a><span class="st">  </span><span class="kw">geom_col</span>(<span class="kw">aes</span>(<span class="dt">x =</span> mean_diff, <span class="dt">y=</span>second_level),</span>
<span id="cb18-19"><a href="#cb18-19"></a>           <span class="dt">fill=</span><span class="st">"black"</span>) <span class="op">+</span></span>
<span id="cb18-20"><a href="#cb18-20"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb18-21"><a href="#cb18-21"></a>    <span class="dt">x =</span> <span class="st">"Rainfall [mm]"</span>,</span>
<span id="cb18-22"><a href="#cb18-22"></a>    <span class="dt">y =</span> <span class="st">""</span>,</span>
<span id="cb18-23"><a href="#cb18-23"></a>    <span class="dt">title =</span> <span class="st">"Mean cumulative rainfall in the 7 days before the movement"</span>,</span>
<span id="cb18-24"><a href="#cb18-24"></a>    <span class="dt">subtitle =</span> <span class="st">"classified in the second level (# of events)"</span></span>
<span id="cb18-25"><a href="#cb18-25"></a>  ) <span class="op">+</span></span>
<span id="cb18-26"><a href="#cb18-26"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span>
<span id="cb18-27"><a href="#cb18-27"></a></span>
<span id="cb18-28"><a href="#cb18-28"></a></span>
<span id="cb18-29"><a href="#cb18-29"></a><span class="co"># ggsave("../../../presentations/internship_resume/plots/plots/rainfall_second_level_seven_days_before_movement.png", width = 12, </span></span>
<span id="cb18-30"><a href="#cb18-30"></a>       height=<span class="dv">8</span><span class="er">)</span>  </span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by .</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
