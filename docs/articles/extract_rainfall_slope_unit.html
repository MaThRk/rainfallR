<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Extract rainfall data for slopeunit-polygons • rainfallR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content=" Extract rainfall data for slopeunit-polygons">
<meta property="og:description" content="rainfallR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rainfallR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ExamplePolygonExtraction.html">ExamplePolygonExtraction</a>
    </li>
    <li>
      <a href="../articles/example_bozen.html">Extracting data for bozen</a>
    </li>
    <li>
      <a href="../articles/extract_rainfall_landslidePoints.html">Extract Rainfalldata for landslide-initiation points</a>
    </li>
    <li>
      <a href="../articles/extract_rainfall_slope_unit.html"> Extract rainfall data for slopeunit-polygons</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="extract_rainfall_slope_unit_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extract rainfall data for slopeunit-polygons</h1>
            
      
      
      <div class="hidden name"><code>extract_rainfall_slope_unit.Rmd</code></div>

    </div>

    
    
<div id="load-the-packages" class="section level1">
<h1 class="hasAnchor">
<a href="#load-the-packages" class="anchor"></a>Load the packages</h1>
<ul>
<li>First we load some of the necessary packages</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="co"># For much of the data preprocessing</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rainfallR</span><span class="op">)</span> <span class="co"># The access and processing of the rainfall data</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span> <span class="co"># Project paths</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gganimate.com">gganimate</a></span><span class="op">)</span> <span class="co"># For a little animation</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">iffitoR</span><span class="op">)</span> <span class="co"># The landslide data</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span> <span class="co"># Handling of the spatial data</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue">glue</a></span><span class="op">)</span> <span class="co"># Concattening strings</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span> <span class="co"># Mapping functions</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/crayon#readme">crayon</a></span><span class="op">)</span>  <span class="co"># Coloured consolde output </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span> <span class="co"># Raster data handling</span></code></pre></div>
</div>
<div id="get-the-slope-units" class="section level1">
<h1 class="hasAnchor">
<a href="#get-the-slope-units" class="anchor"></a>Get the slope units</h1>
<ul>
<li>In order to find the slope units on the hard drive in differs between the Linux and the Microsoft path</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># which os to automatically set the paths</span>
<span class="va">os</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="st">"sysname"</span><span class="op">]</span>

<span class="kw">if</span><span class="op">(</span><span class="va">os</span> <span class="op">==</span> <span class="st">"Linux"</span><span class="op">)</span><span class="op">{</span>
  <span class="va">path_ncdf</span> <span class="op">=</span> <span class="st">"/mnt/CEPH_PROJECTS/Proslide/PREC_GRIDS_updated/"</span>
  <span class="va">su_path</span> <span class="op">=</span> <span class="st">"/mnt/CEPH_PROJECTS/Proslide/Envir_data/SlopeUnits/su_opt_16_TAA/su_16_TAA.shp"</span>
<span class="op">}</span><span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">os</span> <span class="op">==</span> <span class="st">"Windows"</span><span class="op">)</span><span class="op">{</span>
  <span class="va">path_ncdf</span> <span class="op">=</span> <span class="st">"\\\\projectdata.eurac.edu/projects/Proslide/PREC_GRIDS_updated/"</span>
  <span class="va">su_path</span> <span class="op">=</span> <span class="st">"\\\\projectdata.eurac.edu/projects/Proslide/Envir_data/SlopeUnits/su_opt_16_TAA/su_16_TAA.shp"</span>
<span class="op">}</span><span class="kw">else</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span>call. <span class="op">=</span> <span class="cn">F</span>, <span class="st">"what the hell are you working on..."</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="what-have-we-got" class="section level1">
<h1 class="hasAnchor">
<a href="#what-have-we-got" class="anchor"></a>What have we got</h1>
<ul>
<li><p>Lets understand a bit about the data that we got</p></li>
<li><p>The slope units not only cover South Tyrol, but also the trentino Region. So lets mask it</p></li>
<li><p>We can use the <code>iffitoR::get_shape_southtyrol</code>-function in order to get the outline of South Tyrol</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get vector of South Tyrol</span>
<span class="va">st</span> <span class="op">=</span> <span class="fu">iffitoR</span><span class="fu">::</span><span class="fu">get_shape_southtyrol</span><span class="op">(</span><span class="op">)</span> 

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">st</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="extract_rainfall_slope_unit_files/figure-html/plotst-1.png" width="700"></p>
<ul>
<li>Now we get the vector data for the slope units</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">su_orig</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">su_path</span><span class="op">)</span>
<span class="co">#&gt; Reading layer `su_16_TAA' from data source `\\projectdata.eurac.edu\projects\Proslide\Envir_data\SlopeUnits\su_opt_16_TAA\su_16_TAA.shp' using driver `ESRI Shapefile'</span>
<span class="co">#&gt; Simple feature collection with 14543 features and 4 fields</span>
<span class="co">#&gt; geometry type:  POLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: 4350211 ymin: 2507176 xmax: 4510701 ymax: 2666725</span>
<span class="co">#&gt; projected CRS:  Lambert_Azimuthal_Equal_Area</span>
<span class="co"># and verify directly if they are in the same crs</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">su_orig</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">st</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<ul>
<li>As they are not in the same crs, lets reproject the ouline of South Tyrol. The difference, to my knowledge lies in the different geodetic reference systems they use (ETRS89 in the case of South Tyrol and GRS 80 for the slope units).</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">st_reproj</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">st</span>,<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">su_orig</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">st_reproj</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">su_orig</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<div id="clip-the-slopunits-to-south-tyrol" class="section level2">
<h2 class="hasAnchor">
<a href="#clip-the-slopunits-to-south-tyrol" class="anchor"></a>Clip the slopunits to South Tyrol</h2>
<ul>
<li>In order to save some computing time we clip the extent of the slope units to the extent of South Tyrol</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">su</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">su_orig</span>, <span class="va">st_reproj</span><span class="op">)</span>
<span class="co">#&gt; Warning: attribute variables are assumed to be spatially constant throughout all</span>
<span class="co">#&gt; geometries</span>
<span class="co"># are the two bounding boxes equal?</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">st_reproj</span><span class="op">)</span> <span class="co"># for some reason the xmax is not the same</span>
<span class="co">#&gt;  xmin  ymin  xmax  ymax </span>
<span class="co">#&gt;  TRUE  TRUE FALSE  TRUE</span></code></pre></div>
<ul>
<li>How many slope units are left now?</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span><span class="op">(</span><span class="va">su_orig</span><span class="op">)</span> <span class="co"># how many were there</span>
<span class="co">#&gt; [1] 14543     5</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span>
<span class="co">#&gt; [1] 9632    5</span></code></pre></div>
</div>
</div>
<div id="get-the-rainfall-for-the-slope-units" class="section level1">
<h1 class="hasAnchor">
<a href="#get-the-rainfall-for-the-slope-units" class="anchor"></a>Get the rainfall for the slope Units</h1>
<ul>
<li><p>For each Slope Unit we will now get the dates with landslides in them</p></li>
<li><p>We can use the function <code>slide_dates_in_polygon</code> in order to extract all the points (landslides-initiation-points) that fall in each polygon (slope unit)</p></li>
<li><p>As we are using the <code>landsld</code>-object we are considering landslides of all types. Here is where we should apply some kind of filtering in order to select the slides that are of intereset to us.</p></li>
<li><p>Each polygon (could be catchements, slope units, …) will have a column in the output that is called <code>poly_id</code>. Each observation (each row) is uniquely identifiable by the <code>date</code> and the <code>poly_id</code>.</p></li>
<li><p>If there are more than one row for one <code>poly_id</code> this means that in the same polygon on several dates slides happened</p></li>
<li><p>We thus only extract the rainfall once for each polygon that saw a movement on a date</p></li>
<li><p>In order to not neglect the fact that potentially multiple slides could have happened, the column <code>slides_per_poly_date</code> present the number of slides that happened at that day in that polygon</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">su_points_in_poly</span> <span class="op">=</span> <span class="fu">rainfallR</span><span class="fu">::</span><span class="fu"><a href="../reference/slide_dates_in_polygon.html">slide_dates_in_polygon</a></span><span class="op">(</span>poly <span class="op">=</span> <span class="va">su_path</span>
                                                      ,iffi10 <span class="op">=</span> <span class="va">landsld</span>
                                                      ,second_level_regex <span class="op">=</span> <span class="cn">NULL</span>
                                                      ,min_year <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>
<span class="co">#&gt; [1] "using an sf-object as input to the iffi-argument"</span>
<span class="co">#&gt; Reading layer `su_16_TAA' from data source `\\projectdata.eurac.edu\projects\Proslide\Envir_data\SlopeUnits\su_opt_16_TAA\su_16_TAA.shp' using driver `ESRI Shapefile'</span>
<span class="co">#&gt; Simple feature collection with 14543 features and 4 fields</span>
<span class="co">#&gt; geometry type:  POLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: 4350211 ymin: 2507176 xmax: 4510701 ymax: 2666725</span>
<span class="co">#&gt; projected CRS:  Lambert_Azimuthal_Equal_Area</span>
<span class="co">#&gt; Warning: attribute variables are assumed to be spatially constant throughout all</span>
<span class="co">#&gt; geometries</span></code></pre></div>
<ul>
<li><p>Now we have all the dates of all slides that happened within each polygon of su</p></li>
<li><p>One interesting question would be to ask what the day and slope unit was that saw most movements?</p></li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">su_points_in_poly</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">poly_id</span>, <span class="va">date</span>, <span class="va">month.int</span>, <span class="va">second_level</span>, <span class="va">slides_per_poly_date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">slides_per_poly_date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 6 features and 5 fields</span>
<span class="co">#&gt; geometry type:  POLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: 665103.4 ymin: 5142844 xmax: 698604.7 ymax: 5177198</span>
<span class="co">#&gt; projected CRS:  WGS 84 / UTM zone 32N</span>
<span class="co">#&gt; # A tibble: 6 x 6</span>
<span class="co">#&gt;   poly_id date       month.int second_level slides_per_poly~</span>
<span class="co">#&gt;     &lt;int&gt; &lt;date&gt;         &lt;int&gt; &lt;chr&gt;                   &lt;int&gt;</span>
<span class="co">#&gt; 1    3243 2016-08-04         8 translation~               16</span>
<span class="co">#&gt; 2    5802 2014-01-22         1 rotational ~                5</span>
<span class="co">#&gt; 3    3659 2008-07-29         7 rotational ~                3</span>
<span class="co">#&gt; 4    4010 2017-06-24         6 translation~                3</span>
<span class="co">#&gt; 5    4607 2014-02-02         2 fall-type                   3</span>
<span class="co">#&gt; 6    7328 2007-07-26         7 fall-type                   3</span>
<span class="co">#&gt; # ... with 1 more variable: geometry &lt;POLYGON [m]&gt;</span></code></pre></div>
</div>
<div id="extract-the-rainfall-data-for-each-su-with-landslides-for-each-day" class="section level1">
<h1 class="hasAnchor">
<a href="#extract-the-rainfall-data-for-each-su-with-landslides-for-each-day" class="anchor"></a>Extract the rainfall data for each su with landslides for each day</h1>
<ul>
<li>We only are interested in the rainfall of the slope units that actually experienced landslides. Therefore we loop over all the slope units and only take the ones with slides.</li>
</ul>
<blockquote>
<p>What about the rainfall Events that happened in slope units and did not cause landslides?</p>
</blockquote>
<ul>
<li><p>Then we look in the dates column and extract the rainfall for each of the date for that slope unit</p></li>
<li><p>We could do this in sequence</p></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># make a list for each slope unit that as least had one slide</span>
<span class="va">n_su_with_slides</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">su</span><span class="op">$</span><span class="va">slide</span><span class="op">)</span><span class="op">)</span>
<span class="va">su_rainfall</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length<span class="op">=</span><span class="va">n_su_with_slides</span><span class="op">)</span>

<span class="co"># the names of the list are the IDs of the Slope Units</span>
<span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">su</span><span class="op">$</span><span class="va">slide</span><span class="op">)</span>
<span class="va">ids</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">idx</span>,<span class="op">]</span><span class="op">$</span><span class="va">su_id</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">su_rainfall</span><span class="op">)</span> <span class="op">=</span> <span class="va">ids</span>

<span class="co"># a counter for the print messages</span>
<span class="va">counter</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">row</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  
  
  <span class="co"># if there actually happened a slide </span>
  <span class="co"># this will run as many times as the list elements are in su_rainfall</span>
  
 <span class="kw">if</span> <span class="op">(</span><span class="va">su</span><span class="op">[</span><span class="va">row</span>,<span class="op">]</span><span class="op">$</span><span class="va">slide</span><span class="op">)</span> <span class="op">{</span>
   
   <span class="va">n</span> <span class="op">=</span> <span class="va">n_su_with_slides</span>
   <span class="va">str</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">counter</span>, <span class="st">"/"</span>, <span class="va">n</span><span class="op">)</span>
   <span class="va">dashes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">20</span>, <span class="st">"-"</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">yellow</span><span class="op">$</span><span class="va">bold</span><span class="op">$</span><span class="fu">underline</span><span class="op">(</span><span class="st">"\n------------"</span>, <span class="va">str</span>, <span class="va">dashes</span>, <span class="st">"\n\n"</span><span class="op">)</span><span class="op">)</span>
  
   
   
   <span class="co"># get the current id of the slope unit</span>
   <span class="va">current_id</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">row</span>, <span class="op">]</span><span class="op">$</span><span class="va">su_id</span>
    
   <span class="va">dates</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">row</span>,<span class="op">]</span><span class="op">$</span><span class="va">slide_dates</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
    
   <span class="co">## get the rainfall data for that slope unit the first day</span>
   <span class="va">spatial.obj</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">row</span>, <span class="op">]</span>
   <span class="va">days_back</span> <span class="op">=</span> <span class="fl">5</span>
   
   <span class="co"># in case a slope unit experienced more than one slide we need an inner list</span>
   <span class="va">inner_su_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
   
   <span class="co"># get the rainfall for each data a landslide happened in that slope unit</span>
   <span class="co"># as we are just getting one date this loop will only run once</span>
   <span class="kw">for</span> <span class="op">(</span><span class="va">day</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
     
     <span class="va">d</span> <span class="op">=</span> <span class="va">dates</span><span class="op">[[</span><span class="va">day</span><span class="op">]</span><span class="op">]</span>
     
     <span class="va">res</span> <span class="op">=</span> <span class="fu">rainfallR</span><span class="fu">::</span><span class="fu"><a href="../reference/ex_rainfall.html">ex_rainfall</a></span><span class="op">(</span>data_path <span class="op">=</span> <span class="va">path_ncdf</span>, spatial.obj <span class="op">=</span> <span class="va">spatial.obj</span>, fun <span class="op">=</span> <span class="st">"mean"</span>,date <span class="op">=</span> <span class="va">d</span>, days_back <span class="op">=</span> <span class="va">days_back</span> <span class="op">)</span>
     
     <span class="co"># just to make sure you can afterwards identify mulitple slides within one su</span>
     <span class="va">res</span><span class="op">[[</span><span class="st">"slide_su_id"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">day</span>
     
     <span class="co"># add the rainfall of that event to the list of all events for that slope unit</span>
     <span class="va">inner_su_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">inner_su_df</span>, <span class="va">res</span><span class="op">)</span>
   <span class="op">}</span>
   
   <span class="co"># add this to the outer list </span>
  <span class="va">su_rainfall</span><span class="op">[[</span><span class="va">counter</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">inner_su_list</span>
  
  <span class="co"># increment the counter</span>
  <span class="va">counter</span> <span class="op">=</span> <span class="va">counter</span> <span class="op">+</span> <span class="fl">1</span>
  
 <span class="op">}</span> 
<span class="op">}</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">took1</span> <span class="op">=</span> <span class="va">end</span><span class="op">-</span><span class="va">start</span></code></pre></div>
</div>
<div id="lets-do-it-in-parallel-with-the-old-function" class="section level1">
<h1 class="hasAnchor">
<a href="#lets-do-it-in-parallel-with-the-old-function" class="anchor"></a>Lets do it in parallel (with the old function)</h1>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># load the su data with the slide day</span>
<span class="va">su</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"local_data/su_with_slide_dates.Rdata"</span><span class="op">)</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>

<span class="co"># make a list for each slope unit that as least had one slide</span>
<span class="va">n_su_with_slides</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">su</span><span class="op">$</span><span class="va">slide</span><span class="op">)</span><span class="op">)</span>
<span class="va">su_rainfall</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="va">n_su_with_slides</span><span class="op">)</span>

<span class="co"># the names of the list are the IDs of the Slope Units</span>
<span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">su</span><span class="op">$</span><span class="va">slide</span><span class="op">)</span>
<span class="va">ids</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">idx</span>, <span class="op">]</span><span class="op">$</span><span class="va">su_id</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">su_rainfall</span><span class="op">)</span> <span class="op">=</span> <span class="va">ids</span>

<span class="co"># a counter for the print messages</span>
<span class="va">counter</span> <span class="op">=</span> <span class="fl">1</span>

<span class="co"># use eight cores</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>

<span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>
  i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span>,
  .combine <span class="op">=</span> <span class="va">rbind</span>,
  .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rainfallR"</span>,
                <span class="st">"dplyr"</span>,
                <span class="st">"magrittr"</span>,
                <span class="st">"stringr"</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span>
  
  <span class="co"># if there actually happened a slide</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">su</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">$</span><span class="va">slide</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="co"># one dataframe for slope units. Possibly multiple days</span>
    <span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="co"># get the current id of the slope unit</span>
    <span class="va">current_id</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">$</span><span class="va">su_id</span>
    
    <span class="co"># get all the dates in that slope unit</span>
    <span class="va">dates</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">$</span><span class="va">slide_dates</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
    
    <span class="co"># the spatial object is the slope unit in the for loop</span>
    <span class="va">spatial.obj</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>
    
    <span class="co"># lets look back 5 days</span>
    <span class="va">days_back</span> <span class="op">=</span> <span class="fl">5</span>
    
    <span class="co"># in case a slope unit experienced more than one slide we need an inner list</span>
    <span class="co"># inner_su_list = vector("list", length = length(dates))</span>
    
    
    <span class="co"># get the rainfall for each data a landslide happened in that slope unit</span>
    <span class="co"># as we are just getting one date this loop will only run once</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">day</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      
      <span class="co"># get the day in the slope unit</span>
      <span class="va">d</span> <span class="op">=</span> <span class="va">dates</span><span class="op">[[</span><span class="va">day</span><span class="op">]</span><span class="op">]</span>
      
      <span class="va">r</span> <span class="op">=</span> <span class="fu">rainfallR</span><span class="fu">::</span><span class="fu"><a href="../reference/ex_rainfall.html">ex_rainfall</a></span><span class="op">(</span>
        data_path <span class="op">=</span> <span class="va">path_ncdf</span>,
        spatial.obj <span class="op">=</span> <span class="va">spatial.obj</span>,
        fun <span class="op">=</span> <span class="st">"mean"</span>,
        date <span class="op">=</span> <span class="va">d</span>,
        days_back <span class="op">=</span> <span class="va">days_back</span>
      <span class="op">)</span>
      
      <span class="co"># just to make sure you can afterwards identify mulitple slides within one su</span>
      <span class="va">r</span><span class="op">[[</span><span class="st">"su_slide_id"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">day</span>
      
      <span class="co"># add the rainfall of that event to the list of all events for that slope unit</span>
      <span class="co"># stack up the dataframe for each slope unit</span>
      <span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">r</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="co"># return the df</span>
    <span class="va">df</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">took2</span> <span class="op">=</span> <span class="va">end</span> <span class="op">-</span> <span class="va">start</span></code></pre></div>
</div>
<div id="analyze-the-results" class="section level1">
<h1 class="hasAnchor">
<a href="#analyze-the-results" class="anchor"></a>Analyze the results</h1>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># verfiy that each slope unit has one entry for each day</span>
<span class="va">output</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">su_id</span>, <span class="va">su_slide_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/tidyverse.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></code></pre></div>
<div id="look-at-the-antecedent-rainfall" class="section level2">
<h2 class="hasAnchor">
<a href="#look-at-the-antecedent-rainfall" class="anchor"></a>look at the antecedent rainfall</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">output</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">su_id</span>, <span class="va">su_slide_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>unique_id <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">cur_group_id</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">days_before_event</span>,
                  y <span class="op">=</span> <span class="va">cumsum</span>,
                  group <span class="op">=</span> <span class="va">unique_id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_reverse</a></span><span class="op">(</span><span class="op">)</span> 
  </code></pre></div>
</div>
</div>
<div id="use-the-new-slide_dates_in_polygon-function" class="section level1">
<h1 class="hasAnchor">
<a href="#use-the-new-slide_dates_in_polygon-function" class="anchor"></a>Use the new <code>slide_dates_in_polygon</code>-function</h1>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># rename the data to make it consistent</span>
<span class="va">su</span> <span class="op">=</span> <span class="va">su_points_in_poly</span>

<span class="co"># load the libraries to do parallel processing</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: Paket 'foreach' wurde unter R Version 4.0.3 erstellt</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attache Paket: 'foreach'</span>
<span class="co">#&gt; The following objects are masked from 'package:purrr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     accumulate, when</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="co">#&gt; Warning: Paket 'doParallel' wurde unter R Version 4.0.3 erstellt</span>
<span class="co">#&gt; Lade nötiges Paket: iterators</span>
<span class="co">#&gt; Warning: Paket 'iterators' wurde unter R Version 4.0.3 erstellt</span>
<span class="co">#&gt; Lade nötiges Paket: parallel</span>

<span class="co"># use eight cores</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>

<span class="co"># measure the time</span>
<span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>
  i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span>,
  .combine <span class="op">=</span> <span class="va">rbind</span>,
  .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rainfallR"</span>,
                <span class="st">"dplyr"</span>,
                <span class="st">"magrittr"</span>,
                <span class="st">"stringr"</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span>
    
    <span class="co"># get all the dates in that slope unit</span>
    <span class="va">date</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">$</span><span class="va">date</span>
    
    <span class="co"># the spatial object is the slope unit in the for loop</span>
    <span class="va">spatial.obj</span> <span class="op">=</span> <span class="va">su</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>
    
    <span class="co"># lets look back 5 days</span>
    <span class="va">days_back</span> <span class="op">=</span> <span class="fl">5</span>
    
    <span class="va">r</span> <span class="op">=</span> <span class="fu">rainfallR</span><span class="fu">::</span><span class="fu"><a href="../reference/ex_rainfall.html">ex_rainfall</a></span><span class="op">(</span>
      data_path <span class="op">=</span> <span class="va">path_ncdf</span>,
      spatial.obj <span class="op">=</span> <span class="va">spatial.obj</span>,
      fun <span class="op">=</span> <span class="st">"mean"</span>,
      date <span class="op">=</span> <span class="va">date</span>,
      days_back <span class="op">=</span> <span class="va">days_back</span>
    <span class="op">)</span>
  
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>      
<span class="op">}</span>

<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">took2</span> <span class="op">=</span> <span class="va">end</span> <span class="op">-</span> <span class="va">start</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by .</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
